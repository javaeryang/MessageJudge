name: Build Unsigned IPA

on:
  push:
    branches: [ main ]          # 已改为 main
  pull_request:
    branches: [ main]       # PR 时也触发，便于预览

jobs:
  build-ipa:
    runs-on: macos-14           # macos-14 预装 Xcode 15.4+，更稳定（可选 macos-latest）

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive     # 如果有子模块一并拉取

    - name: Select Xcode 15 (or latest stable)
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'     # 建议固定一个稳定版本，也可改成 latest

    - name: Install CocoaPods dependencies (if Podfile exists)
      run: |
        if [ -f Podfile ]; then
          pod install --repo-update
        fi

    - name: Create exportOptions.plist (no signing)
      run: |
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>app-store</string>      <!-- 用 app-store 方法可以跳过签名 -->
          <key>compileBitcode</key>
          <false/>
          <key>uploadBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <false/>
        </dict>
        </plist>
        EOF

    - name: Build & Archive
      run: |
        xcodebuild -project MessageJudge.xcodeproj \
                   -scheme MessageJudge \
                   -configuration Release \
                   -sdk iphoneos \
                   -archivePath ./build/MessageJudge.xcarchive \
                   clean archive

    - name: Export unsigned IPA
      run: |
        xcodebuild -exportArchive \
                   -archivePath ./build/MessageJudge.xcarchive \
                   -exportOptionsPlist exportOptions.plist \
                   -exportPath ./build \
                   -allowProvisioningUpdates   # 防止偶尔的 profile 报错

        cd build
        mkdir Payload
        cp -r MessageJudge.app Payload/
        zip -r9 MessageJudge-unsigned.ipa Payload

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: MessageJudge-unsigned.ipa
        path: build/MessageJudge-unsigned.ipa
        retention-days: 30