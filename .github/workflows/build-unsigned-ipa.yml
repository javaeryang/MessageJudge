name: iOS Build

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby (for CocoaPods)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2

    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods

    - name: Prepare workspace if needed
      run: |
        cd MessageJudge
        if [ -f "Podfile" ]; then
          pod install
        fi

    - name: Determine build target
      run: |
        cd MessageJudge
        if [ -f "MessageJudge.xcworkspace" ]; then
          echo "BUILD_TYPE=workspace" >> $GITHUB_ENV
        elif [ -f "MessageJudge.xcodeproj" ]; then
          echo "BUILD_TYPE=project" >> $GITHUB_ENV
        else
          echo "Error: No Xcode project or workspace found!" >&2
          exit 1
        fi

    - name: Build iOS Archive
      run: |
        cd MessageJudge
        if [ "$BUILD_TYPE" = "workspace" ]; then
          xcodebuild \
            -workspace MessageJudge.xcworkspace \
            -scheme MessageJudge \
            -configuration Release \
            -archivePath build/MessageJudge.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            IPHONEOS_DEPLOYMENT_TARGET=12.0 \
            ONLY_ACTIVE_ARCH=NO
        else
          xcodebuild \
            -project MessageJudge.xcodeproj \
            -scheme MessageJudge \
            -configuration Release \
            -archivePath build/MessageJudge.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            IPHONEOS_DEPLOYMENT_TARGET=12.0 \
            ONLY_ACTIVE_ARCH=NO

    - name: Export IPA (optional)
      run: |
        cd MessageJudge
        xcodebuild -exportArchive \
          -archivePath build/MessageJudge.xcarchive \
          -exportPath build/MessageJudge \
          -exportOptionsPlist ExportOptions.plist || echo "Skipping IPA export"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MessageJudge-iOS
        path: MessageJudge/build/
